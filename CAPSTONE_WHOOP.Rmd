---
title: "Capstone_WHOOP"
author: "Joe Earnshaw"
date: "10/1/2018"
output: html_document
---

LOAD THE DATA SET PLUS QUICK REVIEW OF IT'S STRUCTURE
```{r}
whoop_df_original <- read.csv("capstone_WHOOP_data_14aug_18apr.csv", header = TRUE)

class(whoop_df_original) # shows the class of the whoop_df_original object
names(whoop_df_original) # names of columns in data frame
str(whoop_df_original) # compactly displays the internal structure of whoop_df_original
summary(whoop_df_original) # summary statistics for whoop_df_original

```

STEP 1: CLEANING THE DATA
As we can see from above, there are 61 NA's in most columns, but only 60 NA's in Date and Strain. Let's dive a little deeper into why this is. 
```{r}
whoop_edit <- whoop_df_original

na_whoop_edit = whoop_edit[rowSums(is.na(whoop_edit)) > 0, ]
View(na_whoop_edit)
```

So it looks like the vast majority of the observations in na_whoop_edit contain nothing but NA's. From row 120 to 179, there is no information so I will begin by eliminating these rows. 

```{r}
# remove empty rows 120 - 179
whoop_edit <- whoop_edit[-c(120:179), ]
summary(whoop_edit)
```

From the first structure call we made, we saw that the values in the Recovery and Sleep perfomance columns were factors. To be able to utilize this data further, we need to convert these values from factors to numerics. 
```{r}

#new data frame to edit Recovery column; convert from factors to numerics
whoop_edit_recovery <- whoop_edit
whoop_edit_recovery$Recovery <- as.numeric(sub("%", "e-2", whoop_edit_recovery$Recovery))

class(whoop_edit_recovery$Recovery)
whoop_edit_recovery$Recovery

```

The recovery has been switched to a numeric, taking values between 0.00 and 1.00 (with 0.00 representing 0% recovery and 1.00 representing and 100% recovery). With the recovery column changed, we need to address the factors/numeric issue within the sleep performance column as well. 
```{r}
# current class of sleep performance column
class(whoop_edit_recovery$Sleep.Performance)

# new data set to edit sleep performance
whoop_edit_sleep_perf <- whoop_edit_recovery
whoop_edit_sleep_perf$Sleep.Performance <- as.numeric(sub("%", "e-2", whoop_edit_sleep_perf$Sleep.Performance))
head(whoop_edit_sleep_perf$Sleep.Performance)

# check to see that class of sleep performance column has been updated to numeric
class(whoop_edit_sleep_perf$Sleep.Performance)
```

The next process in cleaning the data is going to be updating the column names. There isn't anything necessarily wrong with them as is, however the use of uppercase, lowercase and periods is somewhat confusing and may lead to frustration as we go further with the project. So, we're going to update the names of the columns to make them a little easier to work with. 

```{r}
#save updates to new data frame, whoop_edit2
whoop_edit2 <- whoop_edit_sleep_perf

# current column names of whoop_edit2 data set
names(whoop_edit2)

# update to column names of whoop_edit2 data set
names(whoop_edit2) = c("date", "strain", "recovery", "sleepPerform", "maxHR", "averHR", "cal", "hrv", "restHR", "timeInBed", "timeLightSleep", "timeREMSleep", "timeDeepSleep", "totalSleep", "sleepCycles")

# quick check to be sure that they have been correctly updated
names(whoop_edit2)

```

To be sure that we understand what each column (and its subsequent data) represents, below is a quick overview of each variable.

VARIABLES IN DATA SET
--> "date" (Date): day, month and year of observation
--> "strain" (Strain): cardiovascular load experienced on the respective date
--> "recovery" (Recovery): body's ability to adapt to training stimulus
--> "sleepPerform" Sleep perfomance: how recovered the athlete is; largely determined by actual amount of sleep versus recommended amount of sleep need according to daily strain
--> "maxHR" (Max HR): max heart rate on that respective date
--> "averHR" (Average HR): average heart over the course of that entire day
--> "cal" (Calories): approx. calories burned based off of cardiovascular load
--> "hrv" (HRV): heart rate variability, a measure of fluctuation in the length of the time interval between successive heartbeats
--> "restHR" (Resting HR): average heart rate during sleeping phase
--> "timeInBed" (Time in bed): The total amount of time spent in bed, which includes time awake and time in state of sleep
--> "timeLightSleep" (Light Sleep): approximate amount of time spent in light sleep stage
--> "timeREMSleep" (REM Sleep): approximate amount of time spent in REM sleep stage
--> "timeDeepSleep" (SWS Deep Sleep): approximate amount of time spent in SWS Deep sleep 
--> "totalSleep" (Total Sleep): total amount of time spent sleeping (which includes Light, REM, and SWS Deep sleep)
--> "sleepCycles" (Sleep cycles): total amount of sleep cycles achieved during that days respective sleep session (1 stage is defined as going from Light, to REM, to SWS Deep sleep without interruption, i.e. waking up, being disturbed, etc.)

Now, the next step is to address the "date" column; currently the observations within that column are factors and we want them to represent actual dates since each one represents the day for which the observed values (see above) apply. 

```{r}
# load lubridate package to easier manipulate dates
library(lubridate)

# create data set to edit the "dates" column and see the current class of it 
date_whoop_edit = whoop_edit2
class(date_whoop_edit$date)

# editing "date" column using dmy() function ('d' for day, 'm' for month, 'y' for year)
date_whoop_edit$date = dmy(date_whoop_edit$date)

# confirming changes made to date and checking overall structure of data set
class(date_whoop_edit$date)
str(date_whoop_edit)

# create new data set
(whoop_edit3 = date_whoop_edit)
```

There are two minor tweaks we still need to make: firstly, we need to eliminate the observation for July 24th because it contains mostly NA's and secondly, we need to replace the NA in the sleep cycles column for the observation on August 9th. We'll replace the sleep cycles observations with the mean of the sleep cycles column for the observed data set. 

```{r}
# delete July 24th observation with mostly NA's and save it into new data set, whoop_edit4
whoop_edit4 = whoop_edit3[-22, ]

# generate value to replace NA in sleepCycle column
na_value_sleepcyc = as.integer(mean(whoop_edit4$sleepCycles, na.rm = TRUE))
whoop_edit4[6, 15] = na_value_sleepcyc

# check to see data set has been correctly updated
summary(whoop_edit4)
```

So now that we have our data set finally cleaned up and ready to go it's time for some initial exploratory analysis! To start we are going to load the ggplot2 package and do some visual analysis to take a deeper dive in the data. First, we'll begin by looking at the data for strain, recovery and sleep performance since these variables are the most important metrics given by WHOOP and ultimately shape how we approach balancing our training with recovery (and sleep!).

EXPLORATORY DATA ANALYSIS
```{r}
#load ggplot libary
library(ggplot2)

# new data set for exploratory analysis
whoop_df_explore = whoop_edit4

# boxplot and histogram of strain data
ggplot(whoop_df_explore, aes(x = "", y = strain)) + 
  geom_boxplot()
ggplot(whoop_df_explore, aes(x = strain)) + 
  geom_histogram(aes(y = ..density..), binwidth = 1, color="black", fill="white") + 
  geom_density(aes(x = strain), alpha=.2, fill="#FF6666") +
  labs(title="Strain Histogram",x="Strain Score")

# boxplot and histogram of recovery data
ggplot(whoop_df_explore, aes(x = "", y = recovery)) + 
  geom_boxplot()
ggplot(whoop_df_explore, aes(x = recovery)) + 
  geom_histogram(aes(y = ..density..), color="black", fill="white", binwidth = 0.05) +
  geom_density(aes(x = recovery), alpha=.2, fill="#FF6666") +
  labs(title="Recovery Histogram",x="Recovery Score")

# boxplot and histogram of sleep performance data
ggplot(whoop_df_explore, aes(x = "", y = sleepPerform)) + 
  geom_boxplot()
ggplot(whoop_df_explore, aes(x = sleepPerform)) + 
  geom_histogram(aes(y =..density..), color="black", fill="white", binwidth = 0.05) +
  geom_density(aes(x = sleepPerform), alpha=.2, fill="#FF6666") +
  labs(title="Sleep Performance Histogram",x="Sleep Performance Score")

```

Ok so we have some cool visuals of the strain, recovery and sleep performance data, now what? Well...the whole point of this project was to determine the underlying biological markers (as mentioned above) that WHOOP also reports on to determine which indicators are crucial in determining these values. Strain is the first metric that we're going to focus on. The supplementary data related to strain that we can gather from WHOOP is max heart rate ("maxHR"), average heart rate ("averHR"), and calories ("cal") for that particular day. We'll begin by seeing what these variables relationships are in regards to strain using scatterplots.

```{r}
library(ggplot2)

# scatter plot with max heart rate on x-axis and strain on y-axis
ggplot(whoop_df_explore, aes(x = maxHR, y = strain)) + 
  geom_point() +
  geom_smooth(method = "lm", se = FALSE)

# scatter plot with average heart rate on x-axis and strain on y-axis
ggplot(whoop_df_explore, aes(x = averHR, y = strain)) +
  geom_point() + 
  geom_smooth(method = "lm", se = FALSE)

# scatter plot with calories on x-axis and strain on y-axis
ggplot(whoop_df_explore, aes(x = cal, y = strain)) +
  geom_point() + 
  geom_smooth(method = "lm", se = FALSE)

# correlation between strain and the three variables
cor(whoop_df_explore$strain, whoop_df_explore$maxHR)
cor(whoop_df_explore$strain, whoop_df_explore$averHR)
cor(whoop_df_explore$strain, whoop_df_explore$cal)
```

From these scatter plots, we can see that all three variables (max heart rate, average heart rate, and calories) appear to have a pretty strong positive correlation with strain. Then by using the cor() function to see the correlation we can confirm that all three variables have a pretty strong positive relationship of 0.8289397 (maxHR), 0.8253186 (averHR), and 0.9176248 (cal). 

What these high correlation values tell me is that there is an obvious connection between strain and max heart rate, average heart rate and calories. From here, we can start to dive into linear regression to see if we can create a model that can accurately predict the daily strain score.

```{r}
# using lm function to create first 
strain_model1 = lm(strain ~ maxHR + averHR + cal, data = whoop_df_explore)
summary(strain_model1)

strain_model2 = lm(strain ~ maxHR + cal, data = whoop_df_explore)
summary(strain_model2)
```
I created two models, strain_model1 and strain_model2, that looks to predict the strain using 3 predictor variables (maxHR, averHR, cal) for the first model and 2 predictor variables (maxHR, cal) for the second model. The reasoning for the second model was to see what the affect on NOT including averHR would do to the model (since averHR's p-value was 0.0452, barely under the 0.05 threshold, and the fact that maxHR and cal showed an overwhelingly significant relationship). The second model proved to be almost as good as the first one, with it's R-squared being only 0.0031 below that of strain_model1. Despite this however, I have decided to go with strain_model1 for further analysis. 

Max heart rate takes the highest heart rate that an individual achieved that day, so it is a good snapshot of what your maximal cardiovascular output was for that day (with a higher max heart rate more likely being achieved with high output activites like training) but it does not take into account heart rate flucuations throughout the day like average heart rate does. There are events that take place during the day (i.e. loading/unloading groceries, playing with kids, etc.) that while aren't maximal effort (which maxHR catches), nonetheless create significant cardiovascular strain on the body and thus average heart rate is better able to capture. This is why I decided to go with the model that includes average heart rate with max heart rate and not just the latter. 

```{r}
# function for first linear regression strainReg
total_daily_strain = function(maxHR, averHR, cal) {
  daily_strain = -13.951038 + maxHR*0.066266 + averHR*0.070551 + cal*0.003163
  print(daily_strain)
}

# load sigr library so we can see statistical summaries more easily
library(sigr)

# F Test summary of strain_model1
wrapFTest(strain_model1)

# create data set specifically for strain regression model
(whoop_df_strain_reg = whoop_df_explore)

# create new column, strainPredict, that shows what the model would predict the strain score would be based off of maxHR, averHR and cal
whoop_df_strain_reg$strainPredict = predict(strain_model1, whoop_df_strain_reg)
head(whoop_df_strain_reg, n = 6)

library(ggplot2)

# scatter plot to show linear regression line (i.e. predicted strain score) against the actual strain scores
ggplot(whoop_df_strain_reg, aes(x = strainPredict, y = strain)) +
  geom_point(alpha = 0.9, shape = 5) +
  geom_abline(color = "red") + 
  labs(title="Scatterplot of Predicted Strain Score vs. Actual Strain Score", x="Predicted Strain (based off model)", y = "Actual Strain Score")

# create new data frame with single observation of maxHR, averHR, and cal to test strain model 
new_strain = data.frame(maxHR = 170, averHR = 67, cal = 3400)
new_strain$prediction = predict(strain_model1, newdata = new_strain)
new_strain

```

Now that we got the predicted strain scores, we're going to create a column with the residuals between the model for strain and the actual observed strain values. 

```{r}
library(ggplot2)

# create new column, strainResiduals, with the residuals b/w predicted strain score and actual strain value
whoop_df_strain_reg$strainResiduals = whoop_df_strain_reg$strain - whoop_df_strain_reg$strainPredict

# plot showcasing residuals of model vs. actual strain value
ggplot(whoop_df_strain_reg, aes(x = strainPredict, y = strainResiduals)) +
  geom_pointrange(aes(ymin = 0, ymax = strainResiduals), alpha = 0.5) +
  geom_hline(yintercept = 0, linetype = 2) +
  labs(title="Plot of Residuals between Predicted Strain Score & Actual Strain Score", x="Strain", y = "Residuals")

# RMSE 
strain_model_error = whoop_df_strain_reg$strainPredict - whoop_df_strain_reg$strain
strain_error_squared = strain_model_error^2
(strain_model_rmse = sqrt(mean(strain_error_squared)))
sd(whoop_df_strain_reg$strain)

## Proportion of values contained between 2 RMSEs
mean(abs(strain_model_error) < 2 * strain_model_rmse)
```

The root mean square error for regression says how far typical points are above or below the regression line. The RMSE is to the regression line as the SD is to the average. For instance, if the scatter diagram is football-shaped, about 68% of the points on the scatter diagram will be within one RMSE of the regression line, about 95% of then will be within 2 RMSE of the regression line.

CROSS VALIDATION OF STRAIN MODEL
```{r}
# Create a cross-validation plan
library(vtreat)

# create new data frame for cross validation, based off of previous data frame
cv_strain_model_df = whoop_df_strain_reg

# function for 3-fold cross validation
splitPlan = kWayCrossValidation(nrow_whoop_df_regression_test, 3, NULL, NULL)
str(splitPlan)

# formula for strain linear regression model
strain_model_formula = as.formula(strain ~ maxHR + averHR + cal)
strain_model_formula
```

CONTINUATION OF CROSS VALIDATION 

```{r}
# number of folds
k = 3

cv_strain_model_df$strainPredict.cv = 0 

for(i in 1:k) {
  split = splitPlan[[i]]
  model = lm(strain_model_formula, data = cv_strain_model_df[split$train, ])
  cv_strain_model_df$strainPredict.cv[split$app] = predict(model, newdata = cv_strain_model_df[split$app, ])
}

# predict from a full model
cv_strain_model_df$strainPredict.cv = predict(strain_model1, data = cv_strain_model_df)

# RMSE for full model's predictions
cv_strain_model_error = cv_strain_model_df$strainPredict - cv_strain_model_df$strain
cv_strain_error_squared = cv_strain_model_error^2
(cv_strain_model_rmse = sqrt(mean(cv_strain_error_squared)))

# RMSE for cross-validation predictions
cvPredict_strain_model_error = cv_strain_model_df$strainPredict.cv - cv_strain_model_df$strain
cvPredict_strain_error_squared = cvPredict_strain_model_error^2
(cvPredict_strain_rmse = sqrt(mean(cvPredict_strain_error_squared)))
```



However, there are two rows that contain observations with the dates of August 9, 2018 and July 24, 2018. August 9th's only missing number is in the 'Sleep.Cycles' column. Since it is only one observation, I will correct this by filling it in with the mean number of sleep cycles. As for July 24th, it looks like it is missing most of it's information and due to this I think it best to eliminate this particular observation. 
